<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Редактор групп меток</title>
  <script src="./js/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    select,
    input,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 5px;
    }

    button:hover {
      background-color: #45a049;
    }

    button.secondary {
      background-color: #2196F3;
    }

    button.danger {
      background-color: #f44336;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    .selected-line {
      background-color: #e6f7ff;
    }

    .file-input {
      display: none;
    }

    button.export {
      background-color: #ff9800;
    }

    .tree-view {
      list-style-type: none;
      padding-left: 20px;
    }

    .tree-item {
      padding: 5px 0;
      cursor: pointer;
    }

    .tree-item.has-children {
      font-weight: bold;
    }

    .tree-item:hover {
      background-color: #f5f5f5;
    }

    .tree-item.selected {
      background-color: #e6f7ff;
      font-weight: bold;
    }

    .tree-toggle {
      cursor: pointer;
      margin-right: 5px;
    }

    .group-controls {
      margin: 15px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }

    .color-preview {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 1px solid #ddd;
      margin-right: 10px;
      vertical-align: middle;
    }

    .color-picker {
      display: inline-block;
      width: 30px;
      height: 30px;
      padding: 0;
      margin-left: 10px;
      vertical-align: middle;
    }

    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .form-row label {
      width: 120px;
      margin-bottom: 0;
    }

    .form-row input[type="text"] {
      flex: 1;
      margin-right: 10px;
    }

    .tag-color {
      display: inline-block;
      width: 15px;
      height: 15px;
      border: 1px solid #ddd;
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Редактор групп меток</h1>

    <div class="form-group">
      <button type="button" onclick="document.getElementById('file-input').click()" class="secondary">
        Загрузить конфиг из файла
      </button>
      <input type="file" id="file-input" class="file-input" accept=".json" onchange="loadConfigFromFile(this.files)">

      <button type="button" onclick="exportToFile()" class="export">
        Экспорт в файл
      </button>

      <button type="button" onclick="showAddGroupForm()" class="secondary">
        Добавить новую группу
      </button>

      <div id="add-group-form" style="display:none; margin-top:10px;">
        <div class="form-row">
          <label>Название:</label>
          <input type="text" id="new-group-name" placeholder="Введите название группы">
        </div>
        <div class="form-row">
          <label>Цвет:</label>
          <input type="color" id="new-group-color" class="color-picker" value="#cccccc">
        </div>
        <div class="form-row">
          <label>Родительская:</label>
          <select id="parent-group-select">
            <option value="">(Корневой уровень)</option>
          </select>
        </div>
        <button type="button" onclick="addGroup()">Добавить</button>
        <button type="button" onclick="hideAddGroupForm()" class="danger">Отмена</button>
      </div>
    </div>

    <div class="group-controls">
      <h3>Выбранная группа:
        <span id="current-group-name">(не выбрано)</span>
        <span id="current-group-color" class="color-preview"></span>
      </h3>
      <div id="group-actions" style="display:none;">
        <button type="button" onclick="showAddTagTypeForm()">Добавить тип метки</button>
        <button type="button" onclick="showEditGroupForm()">Изменить группу</button>
        <button type="button" onclick="removeGroup()" class="danger">Удалить группу</button>
      </div>

      <div id="edit-group-form" style="display:none; margin-top:10px;">
        <div class="form-row">
          <label>Название:</label>
          <input type="text" id="edit-group-name">
        </div>
        <div class="form-row">
          <label>Цвет:</label>
          <input type="color" id="edit-group-color" class="color-picker">
        </div>
        <button type="button" onclick="updateGroup()">Сохранить</button>
        <button type="button" onclick="hideEditGroupForm()" class="danger">Отмена</button>
      </div>
    </div>

    <div class="tree-container">
      <h3>Иерархия групп</h3>
      <ul id="groups-tree" class="tree-view"></ul>
    </div>

    <div id="tags-editor" style="display:none;">
      <h3>Типы меток в группе</h3>
      <table id="tags-table">
        <thead>
          <tr>
            <th>Префикс</th>
            <th>Описание</th>
            <th>Цвет</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="add-tag-form" style="display:none; margin-top:10px;">
        <div class="form-row">
          <label>Префикс:</label>
          <input type="text" id="new-tag-prefix" placeholder="Например, ИНТ" style="width: 100px;">
        </div>
        <div class="form-row">
          <label>Описание:</label>
          <input type="text" id="new-tag-description" placeholder="Описание метки">
        </div>
        <div class="form-row">
          <label>Цвет:</label>
          <input type="color" id="new-tag-color" class="color-picker" value="#cccccc">
        </div>
        <button type="button" onclick="addTagType()">Добавить</button>
        <button type="button" onclick="hideAddTagTypeForm()" class="danger">Отмена</button>
      </div>

      <div id="edit-tag-form" style="display:none; margin-top:10px;">
        <div class="form-row">
          <label>Префикс:</label>
          <input type="text" id="edit-tag-prefix" disabled>
        </div>
        <div class="form-row">
          <label>Описание:</label>
          <input type="text" id="edit-tag-description">
        </div>
        <div class="form-row">
          <label>Цвет:</label>
          <input type="color" id="edit-tag-color" class="color-picker">
        </div>
        <button type="button" onclick="updateTagType()">Сохранить</button>
        <button type="button" onclick="hideEditTagForm()" class="danger">Отмена</button>
      </div>
    </div>

    <div class="actions">
      <button type="button" onclick="saveConfig()" class="primary">Сохранить конфигурацию</button>
      <button type="button" onclick="closeDialog()">Закрыть</button>
    </div>
  </div>

  <script>
    let tagsConfig = {
      groups: {},
      tagTypes: {}
    };
    let currentGroupPath = '';
    let currentGroup = null;
    let currentTagPrefix = '';

    // Инициализация формы при загрузке
    function onLoad(configData) {
      try {
        const data = JSON.parse(configData);
        tagsConfig = {
          groups: data.groups || {},
          tagTypes: data.tagTypes || {}
        };

        // Установка цветов по умолчанию, если их нет
        Object.values(tagsConfig.groups).forEach(group => {
          if (!group.color) group.color = getRandomColor();
        });

        Object.values(tagsConfig.tagTypes).forEach(tag => {
          if (!tag.color) tag.color = getRandomColor();
        });

        populateGroupsTree();
        updateParentGroupSelect();

        // Если есть группы, выбираем первую
        if (Object.keys(tagsConfig.groups).length > 0) {
          selectGroup(Object.keys(tagsConfig.groups)[0]);
        }
      } catch (e) {
        console.error("Ошибка загрузки данных:", e);
        tagsConfig = {
          groups: {},
          tagTypes: {}
        };
      }
    }

    // Генерация случайного цвета
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // Построение дерева групп с цветами
    function populateGroupsTree() {
      const $tree = $('#groups-tree');
      $tree.empty();

      // Собираем корневые группы
      const rootGroups = Object.entries(tagsConfig.groups).filter(
        ([path, group]) => !path.includes('/')
      );

      rootGroups.forEach(([path, group]) => {
        buildTreeItem($tree, path, group);
      });
    }

    // Заполнение таблицы типов меток
    function populateTagsTable() {
      const $tbody = $('#tags-table tbody');
      $tbody.empty();

      if (!currentGroup) return;

      // Находим все метки, принадлежащие этой группе
      const groupTags = Object.entries(tagsConfig.tagTypes).filter(
        ([prefix, tag]) => tag.groupPath === currentGroupPath
      );

      groupTags.forEach(([prefix, tag]) => {
        const row = `
          <tr>
            <td>${prefix}</td>
            <td>${tag.description}</td>
            <td>
              <button onclick="editTagType('${prefix}')">Изменить</button>
              <button onclick="removeTagType('${prefix}')" class="danger">Удалить</button>
            </td>
          </tr>
        `;
        $tbody.append(row);
      });
    }

    // Рекурсивное построение элемента дерева с цветом
    function buildTreeItem($parent, path, group) {
      const $li = $('<li class="tree-item"></li>');
      $li.addClass(group.children ? 'has-children' : '');

      // Ищем дочерние группы
      const childGroups = Object.entries(tagsConfig.groups).filter(
        ([childPath, childGroup]) => childPath.startsWith(path + '/')
      );

      const hasChildren = childGroups.length > 0;

      $li.append(`
        <span class="tree-toggle" onclick="event.stopPropagation(); toggleTreeItem(this)">
          ${hasChildren ? '[-]' : '[ ]'}
        </span>
        <span class="color-preview" style="background-color: ${group.color || '#cccccc'};"></span>
        <span onclick="selectGroup('${path}')">${group.name}</span>
      `);

      if (hasChildren) {
        const $ul = $('<ul class="tree-view" style="display:block;"></ul>');
        childGroups.forEach(([childPath, childGroup]) => {
          buildTreeItem($ul, childPath, childGroup);
        });
        $li.append($ul);
      }

      $parent.append($li);

      // Подсвечиваем выбранную группу
      if (path === currentGroupPath) {
        $li.find('span:not(.tree-toggle):not(.color-preview)').addClass('selected');
      }
    }

    // Выбор группы для редактирования
    function selectGroup(path) {
      currentGroupPath = path;
      currentGroup = tagsConfig.groups[path];

      // Обновляем UI
      $('#current-group-name').text(currentGroup?.name || '(не выбрано)');
      $('#current-group-color').css('background-color', currentGroup?.color || 'transparent');
      $('#group-actions').toggle(!!currentGroup);
      $('#tags-editor').toggle(!!currentGroup);
      hideEditGroupForm();

      // Обновляем выделение в дереве
      $('.tree-item span').removeClass('selected');
      if (currentGroup) {
        $(`.tree-item span:contains('${currentGroup.name}')`).not('.color-preview').addClass('selected');
      }

      if (currentGroup) {
        populateTagsTable();
      }
    }

    function populateGroupsTree() {
      const $tree = $('#groups-tree');
      $tree.empty();

      // Сортируем группы по имени для красивого отображения
      const sortedGroups = Object.entries(tagsConfig.groups).sort((a, b) => {
        return a[1].name.localeCompare(b[1].name);
      });

      // Сначала добавляем корневые группы
      sortedGroups.forEach(([path, group]) => {
        if (!group.parent) {
          buildTreeItem($tree, path, group);
        }
      });

      // Раскрываем путь к текущей группе
      if (currentGroupPath) {
        expandPathToGroup(currentGroupPath);
      }
    }

    function expandPathToGroup(path) {
      let currentPath = '';
      const parts = path.split('/');

      parts.forEach(part => {
        currentPath = currentPath ? `${currentPath}/${part}` : part;
        const $item = $(`.tree-item span:contains('${part}'):not(.tree-toggle):not(.color-preview)`);
        const $toggle = $item.siblings('.tree-toggle');

        if ($toggle.length && $toggle.text() === '[+]') {
          $toggle.text('[-]');
          $item.parent().find('> ul').show();
        }
      });
    }

    // Показать форму добавления группы
    function showAddGroupForm() {
      $('#add-group-form').show();
      $('#new-group-name').focus();
      $('#new-group-color').val(getRandomColor());
    }

    // Скрыть форму добавления группы
    function hideAddGroupForm() {
      $('#add-group-form').hide();
      $('#new-group-name').val('');
    }

    // Показать форму редактирования группы
    function showEditGroupForm() {
      if (!currentGroup) return;

      $('#edit-group-name').val(currentGroup.name);
      $('#edit-group-color').val(currentGroup.color || getRandomColor());
      $('#edit-group-form').show();
      $('#group-actions').hide();
    }

    // Скрыть форму редактирования группы
    function hideEditGroupForm() {
      $('#edit-group-form').hide();
      $('#group-actions').show();
    }

    // Обновление списка родительских групп
    function updateParentGroupSelect() {
      const $select = $('#parent-group-select');
      $select.empty();
      $select.append('<option value="">(Корневой уровень)</option>');

      Object.entries(tagsConfig.groups).forEach(([path, group]) => {
        $select.append(new Option(group.name, path));
      });
    }

    // Добавление новой группы с цветом
    function addGroup() {
      const groupName = $('#new-group-name').val().trim();
      if (!groupName) return;

      const groupColor = $('#new-group-color').val();
      const parentPath = $('#parent-group-select').val();
      const newPath = parentPath ? `${parentPath}/${groupName}` : groupName;

      if (!tagsConfig.groups[newPath]) {
        tagsConfig.groups[newPath] = {
          name: groupName,
          color: groupColor,
          parent: parentPath || null
        };

        // Обновляем родительскую группу (если есть)
        if (parentPath) {
          if (!tagsConfig.groups[parentPath].children) {
            tagsConfig.groups[parentPath].children = [];
          }
          tagsConfig.groups[parentPath].children.push(newPath);
        }

        hideAddGroupForm();
        populateGroupsTree();
        updateParentGroupSelect();
        selectGroup(newPath);
      } else {
        alert("Группа с таким именем уже существует!");
      }
    }

    // Обновление путей групп при переименовании
    function updateGroupPaths(oldPath, newPath) {
      // Обновляем саму группу
      const group = tagsConfig.groups[oldPath];
      tagsConfig.groups[newPath] = group;
      delete tagsConfig.groups[oldPath];

      // Обновляем ссылки в родительской группе
      if (group.parent) {
        const parent = tagsConfig.groups[group.parent];
        const index = parent.children.indexOf(oldPath);
        if (index !== -1) {
          parent.children[index] = newPath;
        }
      }

      // Обновляем дочерние группы
      if (group.children) {
        group.children.forEach(childPath => {
          const child = tagsConfig.groups[childPath];
          child.parent = newPath;

          // Рекурсивно обновляем пути дочерних элементов
          const newChildPath = childPath.replace(oldPath, newPath);
          updateGroupPaths(childPath, newChildPath);
        });
      }

      // Обновляем ссылки в метках
      Object.values(tagsConfig.tagTypes).forEach(tag => {
        if (tag.groupPath === oldPath) {
          tag.groupPath = newPath;
        }
      });
    }

    function updateGroup() {
      if (!currentGroup) return;

      const newName = $('#edit-group-name').val().trim();
      const newColor = $('#edit-group-color').val();

      if (!newName) {
        alert("Название группы не может быть пустым!");
        return;
      }

      // Сохраняем старый путь для поиска в дереве
      const oldPath = currentGroupPath;

      // Обновляем группу
      currentGroup.name = newName;
      currentGroup.color = newColor;

      // Определяем новый путь
      let newPath;
      if (!currentGroup.parent) {
        newPath = newName; // Корневая группа
      } else {
        newPath = `${currentGroup.parent}/${newName}`;
      }

      // Если имя не изменилось, просто обновляем цвет
      if (oldPath === newPath) {
        populateGroupsTree();
        selectGroup(newPath);
        hideEditGroupForm();
        return;
      }

      // Обновляем пути
      updateGroupPaths(oldPath, newPath);

      // Обновляем текущий путь
      currentGroupPath = newPath;

      // Полностью перестраиваем дерево
      populateGroupsTree();
      updateParentGroupSelect();

      // Выбираем обновленную группу
      selectGroup(newPath);
      hideEditGroupForm();
    }

    // Рекурсивное удаление группы и всех дочерних групп
    function removeGroupRecursive(path) {
      const group = tagsConfig.groups[path];

      // Сначала удаляем дочерние группы
      if (group.children) {
        group.children.forEach(childPath => {
          removeGroupRecursive(childPath);
        });
      }

      // Удаляем ссылку из родительской группы
      if (group.parent) {
        const parent = tagsConfig.groups[group.parent];
        const index = parent.children.indexOf(path);
        if (index !== -1) {
          parent.children.splice(index, 1);
        }
      }

      // Удаляем саму группу
      delete tagsConfig.groups[path];

      // Удаляем все метки этой группы
      Object.keys(tagsConfig.tagTypes).forEach(prefix => {
        if (tagsConfig.tagTypes[prefix].groupPath === path) {
          delete tagsConfig.tagTypes[prefix];
        }
      });
    }

    // Удаление группы
    function removeGroup() {
      if (!currentGroup || !confirm(`Удалить группу "${currentGroup.name}" и все вложенные элементы?`)) {
        return;
      }

      // Удаляем группу и все дочерние группы
      removeGroupRecursive(currentGroupPath);

      // Обновляем UI
      currentGroupPath = '';
      currentGroup = null;
      populateGroupsTree();
      updateParentGroupSelect();
      selectGroup('');
    }

    // Показать форму добавления типа метки
    function showAddTagTypeForm() {
      $('#add-tag-form').show();
      $('#new-tag-prefix').focus();
      $('#new-tag-color').val(getRandomColor());
    }

    // Скрыть форму добавления типа метки
    function hideAddTagTypeForm() {
      $('#add-tag-form').hide();
      $('#new-tag-prefix').val('');
      $('#new-tag-description').val('');
    }

    // Показать форму редактирования типа метки
    function showEditTagForm(prefix) {
      const tag = tagsConfig.tagTypes[prefix];
      if (!tag) return;

      currentTagPrefix = prefix;
      $('#edit-tag-prefix').val(prefix);
      $('#edit-tag-description').val(tag.description);
      $('#edit-tag-color').val(tag.color || getRandomColor());

      $('#edit-tag-form').show();
      $('#add-tag-form').hide();
    }

    // Скрыть форму редактирования типа метки
    function hideEditTagForm() {
      $('#edit-tag-form').hide();
      currentTagPrefix = '';
    }

    // Добавление типа метки с цветом
    function addTagType() {
      const prefix = $('#new-tag-prefix').val().trim().toUpperCase();
      const description = $('#new-tag-description').val().trim();
      const color = $('#new-tag-color').val();

      if (!prefix || !description || !currentGroup) return;

      if (!tagsConfig.tagTypes[prefix]) {
        tagsConfig.tagTypes[prefix] = {
          description: description,
          color: color,
          groupPath: currentGroupPath
        };

        hideAddTagTypeForm();
        populateTagsTable();
      } else {
        alert("Тип метки с таким префиксом уже существует!");
      }
    }

    // Обновление типа метки
    function updateTagType() {
      const tag = tagsConfig.tagTypes[currentTagPrefix];
      if (!tag) return;

      const newDescription = $('#edit-tag-description').val().trim();
      const newColor = $('#edit-tag-color').val();

      if (!newDescription) {
        alert("Описание метки не может быть пустым!");
        return;
      }

      tag.description = newDescription;
      tag.color = newColor;

      populateTagsTable();
      hideEditTagForm();
    }

    // Удаление типа метки
    function removeTagType(prefix) {
      if (confirm("Удалить этот тип метки?")) {
        delete tagsConfig.tagTypes[prefix];
        populateTagsTable();
      }
    }

    // Загрузка конфигурации из файла
    function loadConfigFromFile(files) {
      if (files.length === 0) return;

      const file = files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const jsonData = JSON.parse(e.target.result);
          tagsConfig = {
            groups: jsonData.groups || {},
            tagTypes: jsonData.tagTypes || {}
          };

          // Установка цветов по умолчанию, если их нет
          Object.values(tagsConfig.groups).forEach(group => {
            if (!group.color) group.color = getRandomColor();
          });

          Object.values(tagsConfig.tagTypes).forEach(tag => {
            if (!tag.color) tag.color = getRandomColor();
          });

          currentGroupPath = '';
          currentGroup = null;

          populateGroupsTree();
          updateParentGroupSelect();
          $('#tags-editor').hide();

          if (Object.keys(tagsConfig.groups).length > 0) {
            selectGroup(Object.keys(tagsConfig.groups)[0]);
          }

          alert("Конфигурация успешно загружена из файла!");
        } catch (e) {
          alert("Ошибка при чтении файла: " + e.message);
        }
      };

      reader.readAsText(file);
    }

    // Экспорт конфигурации в файл
    function exportToFile() {
      if (Object.keys(tagsConfig.groups).length === 0) {
        alert("Конфигурация пуста, нечего экспортировать!");
        return;
      }

      try {
        // Создаем JSON строку с отступами для лучшей читаемости
        const jsonData = JSON.stringify(tagsConfig, null, 2);

        // Создаем Blob с данными
        const blob = new Blob([jsonData], { type: 'application/json' });

        // Создаем ссылку для скачивания
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // Предлагаем имя файла с текущей датой
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        a.download = `sketchup_tags_config_${dateStr}.json`;

        // Инициируем скачивание
        document.body.appendChild(a);
        a.click();

        // Очищаем
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      } catch (e) {
        alert("Ошибка при экспорте: " + e.message);
      }
    }

    // Сохранение конфигурации
    function saveConfig() {
      sketchup.saveTagsConfig(JSON.stringify(tagsConfig));
    }

    // Закрытие диалога
    function closeDialog() {
      sketchup.closeDialog();
    }

    // Уведомление Ruby о готовности диалога
    $(document).ready(function () {
      window.location = 'skp:dialog_ready';
    });
  </script>
</body>

</html>